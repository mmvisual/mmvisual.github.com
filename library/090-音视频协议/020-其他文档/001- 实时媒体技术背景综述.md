#### 流技术背景
 
流式传输服务器为数字媒体服务，有点类似于Web服务器如何提供网页。它将数字媒体文件分解成数据包，并将其发送给客户端。客户端重新组合（或重建）数据包，并在接收到数据包时呈现媒体。
 
##### 什么是基于文件的流式传输？
 
流式服务器软件支持将服务器可用于本地或网络文件系统的MP4文件流式传输。客户端可以通过适当的RTSP请求（如SETUP和PLAY）向Streaming Server发送请求，以通过给定文件的URL来流式传输文件。由于MP4文件可以有多个轨道，所以客户端必须单独请求每个轨道（这是由客户端程序通过为每个轨道发出单独的SETUP命令完成的，用户只需要知道文件的名称）。当客户端发送流文件请求时，服务器使用配置文件的“ContentRootPath”参数来识别该文件。它解析识别的文件，以获取要流式传输的每个轨道的信息。对于文件中的每个轨道，服务器从文件系统读取数据数据，并向客户端发送RTP数据包流。同样对于每个轨道，服务器通过发送和接收描述流的质量的RTCP数据包与客户端进行定期通信。除了客户端使用PAUSE或TEARDOWN请求中断流之外，RTP流将持续媒体的持续时间。当客户端发出TEARDOWN请求时，RTCP通信停止。    
在上图中，MP4文件被加载到流服务器中。 当客户端发出请求时，服务器与每个客户端建立一对一的RTSP连接。 在建立用于RTP和RTCP数据传输的端口之后，服务器从媒体文件数据中构成RTP数据包，并将数据包发送到客户端特定的端口。 服务器还向客户端发送一个RTCP发送者报告。 客户端从RTP包重建媒体数据，并将定期的RTCP接收器报告发送回服务器。  
#### 实时传输协议（RTP）
 
流服务器使用RTP协议向客户端传送媒体流。
 
使用MP4文件的轨道信息，Streaming Server将每个轨道的媒体数据分解成RTP数据包。然后，流服务器通过UDP套接字将RTP数据包发送到客户端。
 
由服务器发送的每个RTP包包括以下信息：
* RTP头
* RTP有效载荷头
* RTP有效载荷数据
 
RTP头包括：
* RTP版本信息
* 序列号
* 时间戳
* 同步源标识符（SSRC）
 
服务器使用RTP版本2. RTP会话的初始包的序列号由服务器随机生成。每个连续的数据包然后包含单调增加的序列号。序列号是RTP数据包的重要部分，因为它们允许客户端按顺序处理不正常以及丢失的数据包。每个分组包含指示电影中分组数据的时间的时间戳。服务器还生成并将随机偏移添加到每个数据包的RTP时间戳。
 
SSRC由服务器随机生成，并被包含在正在流式传输的每个RTP数据包中。 SSRC将服务器唯一标识为数据包的发起者。
 
为MP4文件获取RTP有效载荷头和数据，并附加到数据包。
 
在启动RTP会话时，服务器确保为每个RTP流建立两个端口（一个用于RTP，一个用于RTCP）。 RTP端口始终具有偶数端口号，RTCP端口具有下一个较高的奇数端口号。例如，13240和13241。
 
服务器在呈现的持续时间内构建并发送RTP数据包。为了提高流的质量，服务器预先提取并缓存可配置的RTP数据量。
 
当所有轨道的数据都已被流传输时，服务器会在等待RTSP会话超时之前暂停RTP流，然后清理RTP流。
 
##### 实时传输控制协议（RTCP）
 
流服务器使用RTCP（实时控制协议）在客户端和服务器之间传送单个流信息。
 
对于基于文件的流媒体
* RTCP发送者报告（来自服务器）为客户端提供质量和每个流的信息（如用于帧内和帧间同步的信息）。
* RTCP接收器报告（来自客户端）从客户端的角度提供关于接收质量的反馈，服务器可以使用这些反馈来提高流的质量。服务器与请求流的客户端保持活动的RTCP通信。服务器发送RTCP发送者报告并接收RTCP接收者报告。

##### 实时流协议（RTSP）
 
流服务器通过TCP套接字接受实时流协议（RTSP）请求。媒体传输的控制涉及到几种不同的RTSP请求。流服务器使用诸如DESCRIBE，OPTIONS，SETUP，PAUSE，PLAY和TEARDOWN之类的RTSP请求，使客户端能够传送数据传输信息，并为各种媒体请求新的RTP会话。
 
当客户端发出流请求时，客户端和服务器之间建立了TCP上的RTSP连接。使用RTSP连接创建和操作RTSP会话。
 
默认情况下，服务器侦听TCP端口554上的RTSP连接。这是可重新配置的。
 
当建立新的RTSP连接时，服务器确保没有超出可配置的连接限制。服务器接受新的RTSP连接并侦听RTSP请求。
 
以下是服务器和客户端之间的流式传输请求列表：
* 选项 - 服务器使用服务器当前支持的命令列表进行响应。这些命令是OPTIONS，DESCRIBE，SETUP，PLAY和TEARDOWN。
* DESCRIBE - 服务器解析给定URL引用的文件，并响应DESCRIBE请求，并提供有关要描述的介质的信息。该信息将通过SDP进行呈现，该标准包含在对RTSP描述的响应中。
* 设置 - 客户端识别所要接收的媒体的哪些音轨（每个音轨通常对应于不同形式的媒体，例如视频，音频等等）。服务器首先尝试将请求绑定到现有的RTSP会话。否则，它将创建一个具有唯一会话ID的新RTSP会话。然后，进行一些必要的初始化流程。最后，如果操作成功，它返回SETUP操作的状态为成功或失败，以及会话ID。
* PLAY - 此请求实际上开始传输客户端在上一个SETUP请求中指定的每个轨道的数据。服务器为当前RTSP会话中的每个磁道预取可配置的RTP数据量。然后，它开始将每个磁道的流作为单独的RTP流，并且返回包括每个RTP流的初始分组的序列号和时间戳的RTSP响应。
* 暂停 - 此请求告诉服务器暂停传输数据流，但它仍然保持会话活动，以便将来可以恢复播放。
* TEADOWN - 此请求结束流式传输特定的电影。服务器停止所有RTP流，并清除给定会话ID的RTP和RTSP会话。一旦客户端发出播放请求，数据将通过RTP（实时传输协议）通过一组UDP套接字（通常为每个音轨的不同套接字）传送给客户端。每个RTP套接字与RTCP（实时传输控制协议）配对，服务器用于向客户端发送定期发送者状态报告，客户端用于将接收者状态报告发送回服务器。
 
要流式传输特定演示文稿，通​​常会在客户端和服务器之间进行以下交互操作步骤：
1. 建立了基于TCP的实时流协议（RTSP）连接
2. 客户端进行RTSP DESCRIBE请求，服务器使用会话描述协议（SDP）进行响应。此信息描述演示文稿中可用的内容和轨迹。
3. 客户端为要流式传输的每个音轨发出RTSP SETUP请求。然后，服务器启动每个磁道的RTP会话，并为要流式传输的每个磁道建立一个RTP和一个RTCP（实时传输控制协议）端口。
4. 然后，客户端使用PLAY，PAUSE或TEARDOWN命令控制演示。当客户端发生问题
  * PLAY，服务器开始发送RTP数据包和RTCP发送者报告。
  * 暂停，服务器停止发送RTP数据包，但继续发送RTCP报告。
  * TEARDOWN，服务器停止所有RTP和RTCP事务，清理RTP会话，然后关闭与客户端的连接。

##### 会话描述协议（SDP）
 
流服务器使用会话描述协议（SDP）向客户端提供关于所请求的介质的信息，例如内容编码，长度，可用性，传输。当客户端进行RTSP DESCRIBE请求时，服务器构建并发送媒体文件中的数据的SDP信息，并将该信息作为对DESCRIBE命令的响应返回。该信息使客户能够了解演示文稿的内容。例如，SDP信息告诉客户端可用于流式传输的轨道数。客户端可以使用此信息并请求特定轨道。
 
通常，SDP向客户提供以下信息：
* 会话名称和目的，如果请求的会话已经被设置。
* 演示说明
* 媒体，例如包含演示文稿的类型格式和编解码器。
* 用于接收媒体的网络信息（如地址，端口，传输协议，媒体的远程地址）
* 有关会话使用带宽的信息
* 可用于流媒体的所有曲目的信息
 
##### 什么是提示曲目？
 
MP4文件中的特定类型的轨道可以是提示轨。 Catra Streaming Server不需要该文件包含执行流式传输的提示轨。在任何情况下，Catra Streaming Server使用提示轨迹，以便在文件中找到它们。提示轨迹是关于媒体的数据，告诉Catra Streaming Server如何流媒体。例如，提示轨迹指示对于电影中的给定时间，相关联的RTP数据位于文件内的某个位置。 Catra Streaming Server然后在该位置找到数据，将数据放入RTP包中，然后流式传输数据包。这使得服务器能够独立于编解码器，因为它不必知道数据的特性。也就是说，Catra Streaming Server将流式传输任何编解码器中的内容，只要有效的提示音可用于该类型的编解码器。
